<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hra: Snake!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            overscroll-behavior: none;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Zmƒõna na 100vh pro lep≈°√≠ vyu≈æit√≠ v√Ω≈°ky */
            height: 100vh; /* Zaji≈°tƒõn√≠, ≈æe body zabere celou v√Ω≈°ku */
            margin: 0;
            padding: 0.5rem;
            overflow: hidden;
        }
        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            touch-action: none;
            position: relative;
            flex-grow: 1; /* Aby wrapper zabral dostupn√Ω prostor */
            max-height: calc(100vh - 150px); /* Omezen√≠ v√Ω≈°ky wrapperu (p≈ôizp≈Øsobit podle pot≈ôeby) */
        }
        canvas {
            background-color: #2d3748;
            border: 4px solid #1a202c;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            max-width: 100%;
            /* V√Ω≈°ka bude nastavena JS, aby byl canvas ƒçtvercov√Ω a ve≈°el se */
            /* height: auto; */
            display: block;
            touch-action: none;
        }
        .control-button {
            background-color: #4a5568;
            color: white;
            border: 2px solid #2d3748;
            padding: 12px 18px;
            border-radius: 10px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px #2d3748;
            margin: 5px;
            font-size: 1.2rem;
            touch-action: manipulation;
        }
        .control-button:hover { background-color: #2d3748; }
        .control-button:active {
            background-color: #1a202c;
            transform: translateY(2px);
            box-shadow: 0 2px #1a202c;
        }
        .hidden { display: none; }
        #messageOverlay, #pauseOverlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
            background-color: rgba(0,0,0,0.85);
            border-radius: 10px;
            z-index: 10;
            width: 80%;
            max-width: 350px;
            pointer-events: none;
        }
        #messageOverlay button {
             font-size: 0.8rem;
             padding: 8px 15px;
             pointer-events: auto;
        }
        #foodSelect {
            font-family: 'Press Start 2P', cursive;
            background-color: #374151;
            color: #e2e8f0;
            border: 2px solid #4a5568;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin-left: 10px;
            cursor: pointer;
        }
        #foodSelect:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
        }
        #foodSelect:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .pause-button {
            font-size: 0.7rem;
            padding: 6px 10px;
            background-color: #f59e0b; /* amber-500 */
            color: #78350f; /* amber-900 */
            box-shadow: 0 3px #b45309; /* amber-700 */
        }
        .pause-button:hover { background-color: #d97706; /* amber-600 */ }
        .pause-button:active { box-shadow: 0 1px #b45309; }
        .pause-button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             box-shadow: 0 3px #7f4a1a;
        }

        #pauseOverlay {
            font-size: 2rem;
            padding: 30px;
            border: 2px solid #f59e0b;
        }
        .powerup-icon {
            font-size: 1.5rem;
            text-shadow: 0 0 5px white;
        }
        #activeEffectDisplay {
            font-size: 0.8rem;
            min-height: 1.2em;
            color: #facc15; /* yellow-400 */
            margin-top: 5px;
        }
        .high-score-label {
            color: #f87171; /* Tailwind red-400 */
        }
        .info-panel {
             width: 100%; /* Zajist√≠, ≈æe panel zabere ≈°√≠≈ôku kontejneru */
             max-width: var(--canvas-width, 600px); /* Omez√≠ ≈°√≠≈ôku panelu na ≈°√≠≈ôku canvasu */
             margin-left: auto;
             margin-right: auto;
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-2 overflow-hidden">

    <header class="mb-2 text-center flex-shrink-0"> <h1 class="text-3xl md:text-5xl font-bold text-green-400">SNAKE</h1>
    </header>

    <div class="game-wrapper relative">
         <div class="info-panel grid grid-cols-2 gap-x-4 gap-y-1 w-full px-1 mb-2 text-sm sm:text-lg">
            <p>Sk√≥re: <span id="score" class="text-yellow-400">0</span></p>
            <p class="text-right">Nej: <span id="highScore" class="high-score-label">0</span></p>
            <div class="col-span-2 flex justify-center items-center mt-1">
                 <label for="foodSelect" class="text-xs mr-1">Ovoce:</label>
                 <select id="foodSelect">
                     <option value="üçé">üçé Jablko</option>
                     <option value="üçí">üçí T≈ôe≈°nƒõ</option>
                     <option value="üçì">üçì Jahoda</option>
                     <option value="üçÜ">üçÜ Lilek</option>
                     <option value="‚≠ê">‚≠ê Hvƒõzda</option>
                     <option value="üíé">üíé Diamant</option>
                 </select>
                 <button id="pauseButton" class="control-button pause-button ml-4">PAUZA</button>
            </div>
        </div>
        <div id="activeEffectDisplay" class="text-center mb-2"></div>

        <canvas id="gameCanvas"></canvas>
        <div id="messageOverlay" class="message-box hidden"> <p id="gameOverText"></p>
            <button id="restartButtonOverlay" class="control-button mt-4">Start</button>
        </div>
        <div id="pauseOverlay" class="hidden">PAUZA</div> </div>

    <div id="mobileControls" class="mt-4 grid grid-cols-3 gap-2 w-full max-w-xs md:hidden flex-shrink-0"> <div></div> <button id="upBtn" class="control-button">‚Üë</button>
        <div></div>
        <button id="leftBtn" class="control-button">‚Üê</button>
        <button id="downBtn" class="control-button">‚Üì</button>
        <button id="rightBtn" class="control-button">‚Üí</button>
    </div>

    <button id="restartButton" class="control-button mt-4 hidden flex-shrink-0">Restart Hry</button> <footer class="mt-4 text-center text-xs text-gray-500 flex-shrink-0"> Ovl√°d√°n√≠: ≈†ipky / WASD / Swipe / Tlaƒç√≠tka | Pauza: Mezern√≠k
    </footer>

    <script>
        // --- Elementy DOM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const highScoreDisplay = document.getElementById('highScore');
        const restartButton = document.getElementById('restartButton');
        const foodSelect = document.getElementById('foodSelect');
        const pauseButton = document.getElementById('pauseButton');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const activeEffectDisplay = document.getElementById('activeEffectDisplay');
        const messageOverlay = document.getElementById('messageOverlay');
        const gameOverText = document.getElementById('gameOverText');
        const restartButtonOverlay = document.getElementById('restartButtonOverlay');
        const infoPanel = document.querySelector('.info-panel'); // Pro nastaven√≠ ≈°√≠≈ôky

        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');

        // --- Hern√≠ stav ---
        const numGridCells = 20;
        let tileSize;
        let snake;
        let food;
        let score = 0;
        let highScore = 0;
        let dx, dy;
        let gameLoopTimeout;
        let baseGameSpeed = 280;
        let gameSpeed = baseGameSpeed;
        let gameOverFlag = false;
        let gamePaused = true; // Hra zaƒç√≠n√° pozastaven√°
        let gameRunning = false;
        let currentFoodEmoji = 'üçé';

        // --- Power-upy ---
        let powerUp = null;
        let powerUpSpawnTimeout;
        let powerUpDespawnTimeout;
        const POWER_UP_TYPES = {
            SLOWDOWN: { emoji: 'üêå', duration: 5000, effectValue: 1.5 },
            DOUBLE_SCORE: { emoji: '‚ú®', duration: 8000, effectValue: 2 }
        };
        const powerUpSpawnInterval = 10000;
        const powerUpLifespan = 7000;
        let activeEffect = null;
        let activeEffectUpdateInterval;

        // --- Swipe ---
        let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
        const swipeThreshold = 25; // M√≠rnƒõ men≈°√≠ pr√°h pro citlivƒõj≈°√≠ swipe

        // --- Funkce ---
        function resizeCanvas() {
            const gameWrapper = document.querySelector('.game-wrapper');
            const titleHeight = document.querySelector('.game-title')?.offsetHeight || 60;
            const footerHeight = document.querySelector('footer')?.offsetHeight || 30;
            const infoPanelHeight = infoPanel?.offsetHeight || 60;
            const mobileControlsHeight = document.getElementById('mobileControls')?.offsetHeight || 0; // V√Ω≈°ka mobiln√≠ch ovladaƒç≈Ø
            const bodyPadding = 16; // 0.5rem * 2

            // V√Ω≈°ka dostupn√° pro .game-wrapper
            const availableWrapperHeight = window.innerHeight - titleHeight - footerHeight - bodyPadding - mobileControlsHeight - 20; // 20px buffer

            // ≈†√≠≈ôka dostupn√° pro .game-wrapper
            const availableWidth = window.innerWidth - bodyPadding - 20; // 20px buffer

            // Velikost canvasu je men≈°√≠ z dostupn√Ωch rozmƒõr≈Ø, m√≠nus prostor pro info panel
            let canvasContainerHeight = availableWrapperHeight - infoPanelHeight - 10; // 10px buffer
            let size = Math.min(availableWidth, canvasContainerHeight, 800); // Omez√≠me max velikost
            if (size < 200) size = 200; // Minim√°ln√≠ velikost

            tileSize = Math.floor(size / numGridCells);
            if (tileSize < 8) tileSize = 8;

            canvas.width = tileSize * numGridCells;
            canvas.height = tileSize * numGridCells;

            // Nastav√≠me maxim√°ln√≠ ≈°√≠≈ôku info panelu podle canvasu
            infoPanel.style.maxWidth = `${canvas.width}px`;
        }


        function initSnake() {
            snake = [{ x: Math.floor(numGridCells / 2) * tileSize, y: Math.floor(numGridCells / 2) * tileSize }];
            dx = tileSize; // Start doprava
            dy = 0;
        }

        function placeItem(itemType) { /* ... beze zmƒõny ... */
            let item = { x: 0, y: 0 };
            let collision = true;
            let attempts = 0;
            while (collision && attempts < 100) {
                item.x = Math.floor(Math.random() * numGridCells) * tileSize;
                item.y = Math.floor(Math.random() * numGridCells) * tileSize;
                collision = false;
                attempts++;
                if (snake) {
                    for (const segment of snake) {
                        if (segment.x === item.x && segment.y === item.y) {
                            collision = true; break;
                        }
                    }
                }
                if (collision) continue;
                if (itemType === 'powerup' && food && food.x === item.x && food.y === item.y) {
                    collision = true; continue;
                }
                if (itemType === 'food' && powerUp && powerUp.x === item.x && powerUp.y === item.y) {
                    collision = true; continue;
                }
            }
            if (attempts >= 100) console.warn("Nepoda≈ôilo se naj√≠t voln√© m√≠sto pro item:", itemType);
            return item;
         }

        function placeFood() {
            const position = placeItem('food');
            food = { ...position, emoji: currentFoodEmoji };
        }

        function spawnPowerUp() { /* ... beze zmƒõny ... */
            if (powerUp || !gameRunning || gamePaused) {
                schedulePowerUpSpawn(); return;
            }
            const position = placeItem('powerup');
            const types = Object.keys(POWER_UP_TYPES);
            const randomTypeKey = types[Math.floor(Math.random() * types.length)];
            const typeData = POWER_UP_TYPES[randomTypeKey];
            powerUp = { ...position, type: randomTypeKey, emoji: typeData.emoji };
            clearTimeout(powerUpDespawnTimeout);
            powerUpDespawnTimeout = setTimeout(() => { powerUp = null; }, powerUpLifespan);
            schedulePowerUpSpawn();
        }

        function schedulePowerUpSpawn() { /* ... beze zmƒõny ... */
            clearTimeout(powerUpSpawnTimeout);
            if (gameRunning && !gamePaused) {
                const nextSpawnTime = powerUpSpawnInterval + (Math.random() - 0.5) * 5000;
                powerUpSpawnTimeout = setTimeout(spawnPowerUp, nextSpawnTime);
            }
        }

        function activateEffect(type) { /* ... beze zmƒõny ... */
             const typeData = POWER_UP_TYPES[type];
            if (!typeData) return;
            clearTimeout(activeEffect?.timeoutId);
            clearInterval(activeEffectUpdateInterval);
            activeEffect = {
                type: type,
                endTime: Date.now() + typeData.duration,
                timeoutId: setTimeout(deactivateEffect, typeData.duration),
                emoji: typeData.emoji
            };
            updateActiveEffectDisplay();
            activeEffectUpdateInterval = setInterval(updateActiveEffectDisplay, 1000);
        }

        function deactivateEffect() { /* ... beze zmƒõny ... */
             const wasSlowdown = activeEffect?.type === 'SLOWDOWN';
            activeEffect = null;
            clearInterval(activeEffectUpdateInterval);
            updateActiveEffectDisplay();
            if (wasSlowdown && !gamePaused && !gameOverFlag) {
                clearTimeout(gameLoopTimeout);
                gameLoop();
            }
        }

        function updateActiveEffectDisplay() { /* ... beze zmƒõny ... */
             if (activeEffect) {
                const remainingTime = Math.max(0, Math.ceil((activeEffect.endTime - Date.now()) / 1000));
                if (remainingTime > 0) {
                    activeEffectDisplay.innerHTML = `Efekt: ${activeEffect.emoji} (${remainingTime}s)`;
                } else {
                    deactivateEffect();
                }
            } else {
                activeEffectDisplay.innerHTML = '';
                clearInterval(activeEffectUpdateInterval);
            }
        }

        function draw() { /* ... beze zmƒõny ... */
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (food) {
                const fontSize = tileSize * 0.8;
                ctx.font = `${fontSize}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(food.emoji, food.x + tileSize / 2, food.y + tileSize / 2 + fontSize * 0.08);
            }
            if (powerUp) {
                 const fontSize = tileSize * 1.0;
                 ctx.font = `${fontSize}px sans-serif`;
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.globalAlpha = 0.7 + Math.sin(Date.now() / 200) * 0.3;
                 ctx.shadowColor = "white";
                 ctx.shadowBlur = 10;
                 ctx.fillText(powerUp.emoji, powerUp.x + tileSize / 2, powerUp.y + tileSize / 2 + fontSize * 0.08);
                 ctx.globalAlpha = 1.0;
                 ctx.shadowBlur = 0;
            }
            if (snake) {
                snake.forEach((segment, index) => {
                    ctx.fillStyle = (index === 0) ? '#48bb78' : '#68d391';
                    ctx.fillRect(segment.x, segment.y, tileSize - 1, tileSize - 1);
                    ctx.strokeStyle = '#2d3748';
                    ctx.strokeRect(segment.x, segment.y, tileSize, tileSize);
                });
            }
         }

        function update() { /* ... beze zmƒõny ... */
            if (gamePaused || gameOverFlag) return;
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height) { gameOver(); return; }
            for (let i = 1; i < snake.length; i++) { if (head.x === snake[i].x && head.y === snake[i].y) { gameOver(); return; } }
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                const scoreMultiplier = activeEffect?.type === 'DOUBLE_SCORE' ? POWER_UP_TYPES.DOUBLE_SCORE.effectValue : 1;
                score += (1 * scoreMultiplier);
                placeFood();
                if (score > 0 && score % 5 === 0 && baseGameSpeed > 80) { baseGameSpeed -= 10; }
            } else if (powerUp && head.x === powerUp.x && head.y === powerUp.y) {
                activateEffect(powerUp.type);
                powerUp = null;
                clearTimeout(powerUpDespawnTimeout);
                snake.pop();
            } else { snake.pop(); }
         }

        function gameLoop() {
            if (gameOverFlag) { clearTimeout(gameLoopTimeout); return; }
            if (gamePaused) {
                // Pokud je pauza, jen napl√°nujeme dal≈°√≠ kontrolu
                gameLoopTimeout = setTimeout(gameLoop, 100); // Kontrolujeme stav pauzy ƒçastƒõji
                return;
            }
            // Pokud hra bƒõ≈æ√≠, provedeme update a draw
            update();
            draw();
            drawScoreAndHighScore();
            const speedMultiplier = activeEffect?.type === 'SLOWDOWN' ? POWER_UP_TYPES.SLOWDOWN.effectValue : 1;
            const currentSpeed = baseGameSpeed * speedMultiplier;
            gameLoopTimeout = setTimeout(gameLoop, currentSpeed); // Napl√°nujeme dal≈°√≠ krok
        }

        function loadHighScore() { /* ... beze zmƒõny ... */
            const storedHighScore = localStorage.getItem('snakeHighScore');
            highScore = storedHighScore ? parseInt(storedHighScore, 10) : 0;
         }

        function updateHighScore() { /* ... beze zmƒõny ... */
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
            }
         }

        function drawScoreAndHighScore() { /* ... beze zmƒõny ... */
            scoreDisplay.textContent = score;
            highScoreDisplay.textContent = highScore;
         }

        function gameOver() { /* ... beze zmƒõny ... */
            gameOverFlag = true;
            gameRunning = false;
            gamePaused = true;
            clearTimeout(gameLoopTimeout);
            clearTimeout(powerUpSpawnTimeout);
            clearTimeout(powerUpDespawnTimeout);
            clearTimeout(activeEffect?.timeoutId);
            clearInterval(activeEffectUpdateInterval);
            updateHighScore();
            activeEffect = null;
            powerUp = null;
            updateActiveEffectDisplay();
            gameOverText.textContent = `KONEC HRY! Sk√≥re: ${score}`;
            messageOverlay.classList.remove('hidden');
            restartButtonOverlay.textContent = "Hr√°t Znovu"; // Zmƒõna textu tlaƒç√≠tka
            restartButton.classList.remove('hidden');
            foodSelect.disabled = false;
            pauseButton.textContent = "PAUZA";
            pauseButton.disabled = true;
            pauseOverlay.classList.add('hidden');
         }

        function changeDirection(newDx, newDy) { /* ... beze zmƒõny ... */
            if (dx !== 0 && newDx !== 0 && dx === -newDx) return;
            if (dy !== 0 && newDy !== 0 && dy === -newDy) return;
            dx = newDx;
            dy = newDy;
         }

        function togglePause() {
            if (gameOverFlag || !gameRunning) return; // Pauza funguje jen kdy≈æ hra bƒõ≈æ√≠
            gamePaused = !gamePaused;
            if (gamePaused) {
                pauseButton.textContent = "POKRAƒåOVAT";
                pauseOverlay.classList.remove('hidden');
                foodSelect.disabled = false;
                clearTimeout(powerUpSpawnTimeout);
                clearInterval(activeEffectUpdateInterval);
                // Smyƒçka se zastav√≠ sama v dal≈°√≠m kroku
            } else {
                pauseButton.textContent = "PAUZA";
                pauseOverlay.classList.add('hidden');
                foodSelect.disabled = true;
                schedulePowerUpSpawn();
                if (activeEffect) {
                    clearInterval(activeEffectUpdateInterval);
                    activeEffectUpdateInterval = setInterval(updateActiveEffectDisplay, 1000);
                    updateActiveEffectDisplay();
                }
                // Explicitnƒõ spust√≠me dal≈°√≠ krok smyƒçky, aby hra pokraƒçovala okam≈æitƒõ
                clearTimeout(gameLoopTimeout);
                gameLoop();
            }
        }

        // --- Ovl√°d√°n√≠ ---
        document.addEventListener('keydown', e => {
            const keyPressed = e.key.toLowerCase();
            if (!gameRunning && !gameOverFlag && (keyPressed === ' ' || keyPressed === 'enter')) {
                 // Start hry, pokud je≈°tƒõ nebƒõ≈æ√≠
                 startGameAction();
                 return;
            }
            if (!gameOverFlag && !gamePaused) { // Ovl√°d√°n√≠ smƒõru
                if ((keyPressed === 'arrowup' || keyPressed === 'w') && dy === 0) changeDirection(0, -tileSize);
                else if ((keyPressed === 'arrowdown' || keyPressed === 's') && dy === 0) changeDirection(0, tileSize);
                else if ((keyPressed === 'arrowleft' || keyPressed === 'a') && dx === 0) changeDirection(-tileSize, 0);
                else if ((keyPressed === 'arrowright' || keyPressed === 'd') && dx === 0) changeDirection(tileSize, 0);
            }
            // Pauza Mezern√≠kem (pokud hra bƒõ≈æ√≠)
            if (keyPressed === ' ' && gameRunning && !gameOverFlag) {
                 e.preventDefault();
                 togglePause();
            }
            // Restart Enterem (pokud je konec hry)
            if (keyPressed === 'enter' && gameOverFlag) {
                 startGameAction();
            }
        });

        // Mobiln√≠ tlaƒç√≠tka
        if (upBtn) upBtn.addEventListener('click', () => { if (dy === 0 && !gameOverFlag && !gamePaused) changeDirection(0, -tileSize); });
        if (downBtn) downBtn.addEventListener('click', () => { if (dy === 0 && !gameOverFlag && !gamePaused) changeDirection(0, tileSize); });
        if (leftBtn) leftBtn.addEventListener('click', () => { if (dx === 0 && !gameOverFlag && !gamePaused) changeDirection(-tileSize, 0); });
        if (rightBtn) rightBtn.addEventListener('click', () => { if (dx === 0 && !gameOverFlag && !gamePaused) changeDirection(tileSize, 0); });

        // Swipe ovl√°d√°n√≠
        canvas.addEventListener('touchstart', (e) => {
            if (gamePaused && gameRunning && !gameOverFlag) { // Pokud je zapauzov√°no, dotyk odpauzuje
                 togglePause();
                 return;
            }
            if (!gameRunning || gameOverFlag) { // Pokud hra nebƒõ≈æ√≠ nebo skonƒçila, dotyk startuje/restartuje
                 startGameAction();
                 return;
            }
            // Pokud hra bƒõ≈æ√≠, zaznamen√°me start swipe
            e.preventDefault();
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            if (gamePaused || gameOverFlag) return; // Swipe nefunguje p≈ôi pauze nebo konci
            e.preventDefault();
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: false });

        function handleSwipe() { /* ... k√≥d pro swipe ... */
             const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const absDeltaX = Math.abs(deltaX);
            const absDeltaY = Math.abs(deltaY);

            // P≈ôid√°me podm√≠nku, aby se smƒõr nemohl zmƒõnit, pokud je swipe p≈ô√≠li≈° kr√°tk√Ω
            if (absDeltaX < swipeThreshold && absDeltaY < swipeThreshold) return;

            if (absDeltaX > absDeltaY) { // Horizont√°ln√≠
                if (deltaX > 0 && dx === 0) changeDirection(tileSize, 0);
                else if (deltaX < 0 && dx === 0) changeDirection(-tileSize, 0);
            } else { // Vertik√°ln√≠
                if (deltaY > 0 && dy === 0) changeDirection(0, tileSize); // Swipe dol≈Ø
                else if (deltaY < 0 && dy === 0) changeDirection(0, -tileSize); // Swipe nahoru
            }
         }

        // Listener pro zmƒõnu v√Ωbƒõru ovoce
        foodSelect.addEventListener('change', (e) => {
            currentFoodEmoji = e.target.value;
            if (food && (gamePaused || gameOverFlag)) {
                food.emoji = currentFoodEmoji;
                draw();
            }
        });

        // Listener pro tlaƒç√≠tko Pauza/Pokraƒçovat
        pauseButton.addEventListener('click', togglePause);


        // --- Spu≈°tƒõn√≠ a Restart ---
        function startGameAction() {
             if (!gameRunning || gameOverFlag) {
                 startGame();
             } else if (gamePaused) {
                 togglePause();
             }
        }

        function startGame() {
            resizeCanvas();
            initSnake();
            currentFoodEmoji = foodSelect.value;
            placeFood();
            score = 0;
            gameOverFlag = false;
            gamePaused = false;
            gameRunning = true;
            baseGameSpeed = 280;
            gameSpeed = baseGameSpeed;

            powerUp = null;
            activeEffect = null;
            clearTimeout(powerUpSpawnTimeout);
            clearTimeout(powerUpDespawnTimeout);
            clearTimeout(activeEffect?.timeoutId);
            clearInterval(activeEffectUpdateInterval);
            updateActiveEffectDisplay();

            messageOverlay.classList.add('hidden');
            pauseOverlay.classList.add('hidden');
            restartButton.classList.add('hidden');
            foodSelect.disabled = true;
            pauseButton.textContent = "PAUZA";
            pauseButton.disabled = false;

            drawScoreAndHighScore();
            clearTimeout(gameLoopTimeout);
            gameLoop();
            schedulePowerUpSpawn();
        }

        restartButton.addEventListener('click', startGameAction);
        restartButtonOverlay.addEventListener('click', startGameAction);

        window.addEventListener('resize', () => {
            const wasPausedBeforeResize = gamePaused;
            const wasRunningBeforeResize = gameRunning;
            const wasGameOver = gameOverFlag;

            clearTimeout(gameLoopTimeout);
            clearTimeout(powerUpSpawnTimeout);
            clearInterval(activeEffectUpdateInterval);
            gamePaused = true;

            resizeCanvas();

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (snake && food) { draw(); } else { initializeGameUI(); return; }
            drawScoreAndHighScore();

            if (wasGameOver) {
                 gameOver();
            } else if (wasRunningBeforeResize && !wasPausedBeforeResize) {
                gamePaused = true; // Nech√°me pauznut√© po resize
                pauseOverlay.classList.remove('hidden');
                foodSelect.disabled = false;
                pauseButton.textContent = "POKRAƒåOVAT";
                pauseButton.disabled = false;
                updateActiveEffectDisplay();
            } else if (wasPausedBeforeResize && wasRunningBeforeResize) {
                gamePaused = true;
                pauseOverlay.classList.remove('hidden');
                foodSelect.disabled = false;
                pauseButton.textContent = "POKRAƒåOVAT";
                pauseButton.disabled = false;
                updateActiveEffectDisplay();
            } else {
                initializeGameUI();
            }
        });

        // --- Inicializace ---
        function initializeGameUI() {
            loadHighScore();
            resizeCanvas();
            initSnake();
            currentFoodEmoji = foodSelect.value;
            placeFood();
            draw();
            score = 0;
            drawScoreAndHighScore();
            foodSelect.disabled = false;
            pauseButton.disabled = true;
            messageOverlay.classList.remove('hidden'); // Zobraz√≠me √∫vodn√≠ zpr√°vu
            pauseOverlay.classList.add('hidden');
            restartButton.classList.add('hidden');
            activeEffectDisplay.innerHTML = '';
            gamePaused = true;
            gameRunning = false;
            gameOverFlag = false;
            powerUp = null;
            activeEffect = null;
            if(gameLoopTimeout) clearTimeout(gameLoopTimeout);
            if(powerUpSpawnTimeout) clearTimeout(powerUpSpawnTimeout);
            if(powerUpDespawnTimeout) clearTimeout(powerUpDespawnTimeout);
            if(activeEffect?.timeoutId) clearTimeout(activeEffect.timeoutId);
            if(activeEffectUpdateInterval) clearInterval(activeEffectUpdateInterval);
            gameOverText.textContent = "Stiskni tlaƒç√≠tko, Mezern√≠k, Enter nebo tapni pro start"; // Upraven√° √∫vodn√≠ zpr√°va
            restartButtonOverlay.textContent = "Start";
        }

        initializeGameUI();
    </script>

</body>
</html>
